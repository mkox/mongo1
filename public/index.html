<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Feathers Example</title>
  <link rel="stylesheet" href="//unpkg.com/feathers-chat@4.0.0/public/base.css">
  <link rel="stylesheet" href="//unpkg.com/feathers-chat@4.0.0/public/chat.css">
</head>
<body>
  <main id="main" class="container">
    <h1>Welcome to Feathers</h1>
    <form class="form" onsubmit="svTwitter(event.preventDefault())">
      <input type="text" id="max-follower-per-twittercall" value="1000"> (used for testing, should normally be 1000)<br>
      <input type="text" id="message-text" placeholder="Enter user id here">
      <button type="submit" class="button button-primary">Send user id</button>
    </form>

    <h2>Here are the current messages:</h2>
    <br /><br /><br />
        <form class="form" onsubmit="getRandomFollowers(event.preventDefault())">
          <label for="followed-for-random-users">Get random followers of a single followed:</label>
          <select id="followed-for-random-users" name="followed-for-random-users">
          </select>
          <input type="submit">
        </form>
  </main>

  <script src="//unpkg.com/@feathersjs/client@^4.3.0/dist/feathers.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
  <script type="text/javascript">
    // Set up socket.io
    const socket = io('http://localhost:3030');
    // Initialize a Feathers app
    const app = feathers();
    var followersCount = 0;
    
    // Register socket.io to talk to our server
    app.configure(feathers.socketio(socket));

    // Form submission handler that sends a new message
    async function svTwitter () {
      var messageInput = document.getElementById('message-text');
      var maxResults = document.getElementById('max-follower-per-twittercall');

      // Create a new message with the input field value
      //await app.service('svTwitter6').getAndStoreTwitterUsers({
      //await app.service('sv_twitter6').create({
      //await app.service('svabcd').create({
      //await app.service('svabcd').myfun({
      await app.service('sv-twitter-7').create({
        text: messageInput.value,
        maxResults: maxResults.value
      });

      messageInput.value = '';
    }

    async function getRandomFollowers () {
      var followedForRandomUsers = document.getElementById('followed-for-random-users');

      const followers = await app.service('sv-twitter-7').find({ query: {followedUserId: followedForRandomUsers.value} });

      console.log(followers);
      followers.forEach(addFollower);

    }

    // Renders a single follower on the page
    function addFollower (follower) {
      followersCount++;
      document.getElementById('main').innerHTML += 
      `<p>${followersCount} - <a href="https://twitter.com/${follower.twUser.username}" target="_blank">${follower.twUser.username}</a> - ${follower.twUser.name} - ${follower.twUser.public_metrics.followers_count} - ${follower.twUser.public_metrics.following_count} - ${follower.twUser.description}</p>`;
    }
    
    const mainRandom = async () => {
      // Find all existing messages
      //const followers = await app.service('sv-twitter-7').find({query:{$skip: 26}});
      const followers = await app.service('sv-twitter-7').find();

      console.log(followers);
      followers.forEach(addFollower);

      /*
      var followersData = followers.data;

      // Add existing messages to the list
      //followers.forEach(addFollower);
      followersData.forEach(addFollower);
      */

      /*
      // Add any newly created message to the list in real-time
      app.service('messages').on('created', addFollower);
      */
    };

    //mainRandom();

    // Renders a single followed to a select form
    function addFollowed (followed) {
      document.getElementById('followed-for-random-users').innerHTML += 
      `<option value="${followed.twUserId}">${followed.twUser.username}</option>`
    }

    const afterStart = async () => {
      const followed = await app.service('followed').find();
      console.log(followed);
      var followedData = followed.data;
      followedData.forEach(addFollowed);
    }

    afterStart();

  </script>
</body>
</html>
