<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Twitter tasks</title>
  <link rel="stylesheet" href="//unpkg.com/feathers-chat@4.0.0/public/base.css">
  <link rel="stylesheet" href="//unpkg.com/feathers-chat@4.0.0/public/chat.css">
</head>
<body>
  <main id="main" class="container">
    <h1>Twitter tasks</h1>

    <h2>Store followers of a single user:</h2>
    <form class="form" onsubmit="svTwitter(event.preventDefault())">
      <input type="text" id="max-follower-per-twittercall" value="1000"> (used for testing, should normally be 1000)<br>
      <input type="text" id="message-text" placeholder="Enter user id here">
      <button type="submit" class="button button-primary">Send user id</button>
    </form>

    <h2>Get user list:</h2>
        <form class="form" onsubmit="getRandomFollowers(event.preventDefault())">
          <label for="followed-for-random-users">Get random followers of a single followed:</label>
          <select id="followed-for-random-users" name="followed-for-random-users">
          </select><br>
          <label for="minimum-of-followers">Minimum of followers:</label>
          <input type="text" id="minimum-of-followers" value="10"><br>
          <label for="how-much-random-users">How much random users:</label>
          <input type="text" id="how-much-random-users" value="250"><br>
          <button type="submit" class="button button-primary">Get random users</button>
        </form>
    
    <h3>User list:</h3>
    <div id="user-list"></div>
  </main>

  <script src="//unpkg.com/@feathersjs/client@^4.3.0/dist/feathers.js"></script>
  <script src="//cdnjs.cloudflare.com/ajax/libs/socket.io/2.0.4/socket.io.js"></script>
  <script type="text/javascript">
    // Set up socket.io
    const socket = io('http://localhost:3030');
    // Initialize a Feathers app
    const app = feathers();
    var followersCount = 0;
    
    // Register socket.io to talk to our server
    app.configure(feathers.socketio(socket));

    // Create a mongo table with followers of a single followed
    async function svTwitter () {
      var messageInput = document.getElementById('message-text');
      var maxResults = document.getElementById('max-follower-per-twittercall');

      await app.service('sv-twitter-7').create({
        text: messageInput.value,
        maxResults: maxResults.value
      });

      messageInput.value = '';
    }

    async function getRandomFollowers () {
      document.getElementById('user-list').innerHTML = '';
      followersCount = 0;
      var followedForRandomUsers = document.getElementById('followed-for-random-users');
      var minimumOfFollowers = document.getElementById('minimum-of-followers');
      var howMuchRandomUsers = document.getElementById('how-much-random-users');

      const followers = await app.service('sv-twitter-7').find({ 
        query: {
          followedUserId: followedForRandomUsers.value,
          numberOfUsers: howMuchRandomUsers.value,
          minimumOfFollowers: minimumOfFollowers.value
        } 
      });

      console.log(followers);
      followers.forEach(addFollower);

    }

    // Renders a single follower on the page
    function addFollower (follower) {
      followersCount++;
      document.getElementById('user-list').innerHTML += 
      `<p>${followersCount} - <a href="https://twitter.com/${follower.twUser.username}" target="_blank">${follower.twUser.username}</a> - ${follower.twUser.name} - ${follower.twUser.public_metrics.followers_count} - ${follower.twUser.public_metrics.following_count} - ${follower.twUser.description}</p>`;
    }

    // Renders a single followed to a select form
    function addFollowed (followed) {
      document.getElementById('followed-for-random-users').innerHTML += 
      `<option value="${followed.twUserId}">${followed.twUser.username}</option>`
    }

    const afterStart = async () => {
      const followed = await app.service('followed').find();
      console.log(followed);
      var followedData = followed.data;
      followedData.forEach(addFollowed);
    }

    afterStart();

  </script>
</body>
</html>
